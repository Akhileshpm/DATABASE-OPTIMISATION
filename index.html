
<!-- saved from url=(0014)about:internet -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Optimizing PostgreSQL Queries: From 300 Seconds to 2 Seconds for Billions of Records | by Code Geass - Freedium</title>
        
        <meta name="description" content="I was working on a huge volumes where I had this entire experience of optimizing the PostgreSQL,...">
        <meta name="keywords" content="medium, paywall, medium.com, paywall breakthrough">

        <script src="./Optimizing PostgreSQL Queries_ From 300 Seconds to 2 Seconds for Billions of Records _ by Code Geass - Freedium_files/saved_resource"></script>
        <!--<script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>-->
        <link href="./Optimizing PostgreSQL Queries_ From 300 Seconds to 2 Seconds for Billions of Records _ by Code Geass - Freedium_files/unbound.css" rel="stylesheet">
        <link rel="apple-touch-icon" sizes="180x180" href="https://www.freedium.cfd/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="https://www.freedium.cfd/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="https://www.freedium.cfd/favicon-16x16.png">
        <link rel="manifest" href="https://www.freedium.cfd/site.webmanifest">
        <link rel="mask-icon" href="https://www.freedium.cfd/safari-pinned-tab.svg" color="#00aba9">
        <meta name="msapplication-TileColor" content="#00aba9">
        <meta name="theme-color" content="#ffffff">
        <script src="./Optimizing PostgreSQL Queries_ From 300 Seconds to 2 Seconds for Billions of Records _ by Code Geass - Freedium_files/highlight.min.js"></script>
        
        <script src="./Optimizing PostgreSQL Queries_ From 300 Seconds to 2 Seconds for Billions of Records _ by Code Geass - Freedium_files/parent"></script>
        <script src="./Optimizing PostgreSQL Queries_ From 300 Seconds to 2 Seconds for Billions of Records _ by Code Geass - Freedium_files/lazyload.min.js"></script>
        <script src="./Optimizing PostgreSQL Queries_ From 300 Seconds to 2 Seconds for Billions of Records _ by Code Geass - Freedium_files/lightense.min.js"></script>

        <script>iframeResize({ license: 'GPLv3' })</script>
    <style>/* ! tailwindcss v3.4.5 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]{display:none}*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }.container{width:100%}@media (min-width: 640px){.container{max-width:640px}}@media (min-width: 768px){.container{max-width:768px}}@media (min-width: 1024px){.container{max-width:1024px}}@media (min-width: 1280px){.container{max-width:1280px}}@media (min-width: 1536px){.container{max-width:1536px}}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{inset:0px}.bottom-0{bottom:0px}.bottom-4{bottom:1rem}.left-4{left:1rem}.right-0{right:0px}.top-0{top:0px}.top-5{top:1.25rem}.z-20{z-index:20}.m-1\.5{margin:0.375rem}.m-2{margin:0.5rem}.mx-1{margin-left:0.25rem;margin-right:0.25rem}.mx-auto{margin-left:auto;margin-right:auto}.my-8{margin-top:2rem;margin-bottom:2rem}.mb-2{margin-bottom:0.5rem}.mb-4{margin-bottom:1rem}.mr-3{margin-right:0.75rem}.mt-0{margin-top:0px}.mt-1{margin-top:0.25rem}.mt-2{margin-top:0.5rem}.mt-3{margin-top:0.75rem}.mt-4{margin-top:1rem}.mt-5{margin-top:1.25rem}.mt-7{margin-top:1.75rem}.mt-8{margin-top:2rem}.block{display:block}.inline-block{display:inline-block}.flex{display:flex}.hidden{display:none}.h-1{height:0.25rem}.h-11{height:2.75rem}.h-3{height:0.75rem}.h-full{height:100%}.max-h-\[95vh\]{max-height:95vh}.max-h-screen{max-height:100vh}.w-11{width:2.75rem}.w-11\/12{width:91.666667%}.w-3{width:0.75rem}.w-full{width:100%}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.flex-grow{flex-grow:1}.list-decimal{list-style-type:decimal}.list-disc{list-style-type:disc}.appearance-none{-webkit-appearance:none;appearance:none}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-2{gap:0.5rem}.space-x-2 > :not([hidden]) ~ :not([hidden]){--tw-space-x-reverse:0;margin-right:calc(0.5rem * var(--tw-space-x-reverse));margin-left:calc(0.5rem * calc(1 - var(--tw-space-x-reverse)))}.space-x-4 > :not([hidden]) ~ :not([hidden]){--tw-space-x-reverse:0;margin-right:calc(1rem * var(--tw-space-x-reverse));margin-left:calc(1rem * calc(1 - var(--tw-space-x-reverse)))}.overflow-x-auto{overflow-x:auto}.overflow-y-auto{overflow-y:auto}.break-normal{overflow-wrap:normal;word-break:normal}.break-words{overflow-wrap:break-word}.rounded{border-radius:0.25rem}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:0.5rem}.rounded-md{border-radius:0.375rem}.border{border-width:1px}.border-2{border-width:2px}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219 / var(--tw-border-opacity))}.border-gray-600{--tw-border-opacity:1;border-color:rgb(75 85 99 / var(--tw-border-opacity))}.border-white{--tw-border-opacity:1;border-color:rgb(255 255 255 / var(--tw-border-opacity))}.bg-black{--tw-bg-opacity:1;background-color:rgb(0 0 0 / var(--tw-bg-opacity))}.bg-blue-500{--tw-bg-opacity:1;background-color:rgb(59 130 246 / var(--tw-bg-opacity))}.bg-blue-800{--tw-bg-opacity:1;background-color:rgb(30 64 175 / var(--tw-bg-opacity))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246 / var(--tw-bg-opacity))}.bg-gray-300{--tw-bg-opacity:1;background-color:rgb(209 213 219 / var(--tw-bg-opacity))}.bg-gray-500{--tw-bg-opacity:1;background-color:rgb(107 114 128 / var(--tw-bg-opacity))}.bg-gray-700{--tw-bg-opacity:1;background-color:rgb(55 65 81 / var(--tw-bg-opacity))}.bg-green-100{--tw-bg-opacity:1;background-color:rgb(220 252 231 / var(--tw-bg-opacity))}.bg-green-500{--tw-bg-opacity:1;background-color:rgb(34 197 94 / var(--tw-bg-opacity))}.bg-red-400{--tw-bg-opacity:1;background-color:rgb(248 113 113 / var(--tw-bg-opacity))}.bg-red-500{--tw-bg-opacity:1;background-color:rgb(239 68 68 / var(--tw-bg-opacity))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity))}.bg-opacity-50{--tw-bg-opacity:0.5}.fill-current{fill:currentColor}.p-2{padding:0.5rem}.p-4{padding:1rem}.p-5{padding:1.25rem}.p-1{padding:0.25rem}.px-2{padding-left:0.5rem;padding-right:0.5rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-1{padding-top:0.25rem;padding-bottom:0.25rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.pb-2{padding-bottom:0.5rem}.pb-3{padding-bottom:0.75rem}.pb-5{padding-bottom:1.25rem}.pl-4{padding-left:1rem}.pl-8{padding-left:2rem}.pr-4{padding-right:1rem}.pt-1{padding-top:0.25rem}.pt-12{padding-top:3rem}.pt-20{padding-top:5rem}.pt-6{padding-top:1.5rem}.pt-8{padding-top:2rem}.text-left{text-align:left}.text-center{text-align:center}.font-sans{font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-base{font-size:1rem;line-height:1.5rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-bold{font-weight:700}.font-extrabold{font-weight:800}.font-medium{font-weight:500}.font-semibold{font-weight:600}.leading-8{line-height:2rem}.leading-normal{line-height:1.5}.leading-tight{line-height:1.25}.text-black{--tw-text-opacity:1;color:rgb(0 0 0 / var(--tw-text-opacity))}.text-gray-500{--tw-text-opacity:1;color:rgb(107 114 128 / var(--tw-text-opacity))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99 / var(--tw-text-opacity))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81 / var(--tw-text-opacity))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55 / var(--tw-text-opacity))}.text-gray-900{--tw-text-opacity:1;color:rgb(17 24 39 / var(--tw-text-opacity))}.text-green-500{--tw-text-opacity:1;color:rgb(34 197 94 / var(--tw-text-opacity))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity))}.text-yellow-500{--tw-text-opacity:1;color:rgb(234 179 8 / var(--tw-text-opacity))}.no-underline{-webkit-text-decoration-line:none;text-decoration-line:none}.shadow{--tw-shadow:0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 1px 3px 0 var(--tw-shadow-color), 0 1px 2px -1px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.hover\:border-green-500:hover{--tw-border-opacity:1;border-color:rgb(34 197 94 / var(--tw-border-opacity))}.hover\:bg-blue-600:hover{--tw-bg-opacity:1;background-color:rgb(37 99 235 / var(--tw-bg-opacity))}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216 / var(--tw-bg-opacity))}.hover\:bg-blue-900:hover{--tw-bg-opacity:1;background-color:rgb(30 58 138 / var(--tw-bg-opacity))}.hover\:bg-gray-400:hover{--tw-bg-opacity:1;background-color:rgb(156 163 175 / var(--tw-bg-opacity))}.hover\:bg-gray-600:hover{--tw-bg-opacity:1;background-color:rgb(75 85 99 / var(--tw-bg-opacity))}.hover\:bg-gray-700:hover{--tw-bg-opacity:1;background-color:rgb(55 65 81 / var(--tw-bg-opacity))}.hover\:bg-red-500:hover{--tw-bg-opacity:1;background-color:rgb(239 68 68 / var(--tw-bg-opacity))}.hover\:bg-red-600:hover{--tw-bg-opacity:1;background-color:rgb(220 38 38 / var(--tw-bg-opacity))}.hover\:text-gray-900:hover{--tw-text-opacity:1;color:rgb(17 24 39 / var(--tw-text-opacity))}.hover\:underline:hover{-webkit-text-decoration-line:underline;text-decoration-line:underline}.hover\:no-underline:hover{-webkit-text-decoration-line:none;text-decoration-line:none}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}.focus\:ring-2:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000)}.focus\:ring-blue-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(59 130 246 / var(--tw-ring-opacity))}.dark\:border-gray-700:is(.dark *){--tw-border-opacity:1;border-color:rgb(55 65 81 / var(--tw-border-opacity))}.dark\:bg-gray-600:is(.dark *){--tw-bg-opacity:1;background-color:rgb(75 85 99 / var(--tw-bg-opacity))}.dark\:bg-gray-800:is(.dark *){--tw-bg-opacity:1;background-color:rgb(31 41 55 / var(--tw-bg-opacity))}.dark\:bg-gray-900:is(.dark *){--tw-bg-opacity:1;background-color:rgb(17 24 39 / var(--tw-bg-opacity))}.dark\:bg-green-700:is(.dark *){--tw-bg-opacity:1;background-color:rgb(21 128 61 / var(--tw-bg-opacity))}.dark\:bg-green-800:is(.dark *){--tw-bg-opacity:1;background-color:rgb(22 101 52 / var(--tw-bg-opacity))}.dark\:bg-zinc-800:is(.dark *){--tw-bg-opacity:1;background-color:rgb(39 39 42 / var(--tw-bg-opacity))}.dark\:text-gray-100:is(.dark *){--tw-text-opacity:1;color:rgb(243 244 246 / var(--tw-text-opacity))}.dark\:text-gray-200:is(.dark *){--tw-text-opacity:1;color:rgb(229 231 235 / var(--tw-text-opacity))}.dark\:text-white:is(.dark *){--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity))}.dark\:text-yellow-400:is(.dark *){--tw-text-opacity:1;color:rgb(250 204 21 / var(--tw-text-opacity))}.dark\:hover\:text-white:hover:is(.dark *){--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity))}@media (min-width: 768px){.md\:inline{display:inline}.md\:max-w-3xl{max-width:48rem}.md\:max-w-4xl{max-width:56rem}.md\:max-w-xl{max-width:36rem}.md\:px-6{padding-left:1.5rem;padding-right:1.5rem}.md\:text-2xl{font-size:1.5rem;line-height:2rem}.md\:text-4xl{font-size:2.25rem;line-height:2.5rem}.md\:text-sm{font-size:0.875rem;line-height:1.25rem}.md\:text-xl{font-size:1.25rem;line-height:1.75rem}}@media (min-width: 1024px){.lg\:mt-0{margin-top:0px}.lg\:block{display:block}.lg\:flex{display:flex}.lg\:hidden{display:none}.lg\:w-auto{width:auto}.lg\:items-center{align-items:center}}</style><link rel="stylesheet" href="./Optimizing PostgreSQL Queries_ From 300 Seconds to 2 Seconds for Billions of Records _ by Code Geass - Freedium_files/a11y-light.min.css"><style id="lightense-images-css">
:root {
  --lightense-z-index: 999999;
  --lightense-backdrop: var(--bg-color-80, rgba(255, 255, 255, .98));
  --lightense-duration: 300ms;
  --lightense-timing-func: cubic-bezier(.2, 0, .1, 1);
}

.lightense-backdrop {
  box-sizing: border-box;
  width: 100%;
  height: 100%;
  position: fixed;
  top: 0;
  left: 0;
  overflow: hidden;
  z-index: calc(var(--lightense-z-index) - 1);
  padding: 0;
  margin: 0;
  transition: opacity var(--lightense-duration) ease;
  cursor: zoom-out;
  opacity: 0;
  background-color: var(--lightense-backdrop);
  visibility: hidden;
}

@supports (-webkit-backdrop-filter: blur(30px)) {
  .lightense-backdrop {
    background-color: var(--lightense-backdrop);
    -webkit-backdrop-filter: blur(30px);
  }
}

@supports (backdrop-filter: blur(30px)) {
  .lightense-backdrop {
    background-color: var(--lightense-backdrop);
    backdrop-filter: blur(30px);
  }
}

.lightense-wrap {
  position: relative;
  transition: transform var(--lightense-duration) var(--lightense-timing-func);
  z-index: var(--lightense-z-index);
  pointer-events: none;
}

.lightense-target {
  cursor: zoom-in;
  transition: transform var(--lightense-duration) var(--lightense-timing-func);
  pointer-events: auto;
}

.lightense-open {
  cursor: zoom-out;
}

.lightense-transitioning {
  pointer-events: none;
}</style></head>
    <body class="dark:bg-gray-800 bg-white"><div class="fixed bottom-4 left-4" style="z-index: 999999;">
        <button id="openProblemModal" class="m-1.5 flex items-center bg-red-500 text-white py-2 px-4 rounded-full shadow-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512">
                <!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><style>svg{fill:#ffffff}</style>
                <path d="M256 32c14.2 0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7 .2 40.1S486.3 480 472 480H40c-14.3 0-27.6-7.7-34.7-20.1s-7-27.8 .2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3 0-24 10.7-24 24V296c0 13.3 10.7 24 24 24s24-10.7 24-24V184c0-13.3-10.7-24-24-24zm32 224a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"></path>
            </svg>
        </button>
        <button id="darkModeToggle" class="m-1.5 flex items-center bg-blue-500 text-white py-2 px-4 rounded-full shadow-lg hover:bg-blue-600 focus:outline-none">
            <svg id="darkIcon" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 384 512" class="hidden">
                <!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
                <path d="M223.5 32C100 32 0 132.3 0 256S100 480 223.5 480c60.6 0 115.5-24.2 155.8-63.4c5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-9.8 1.7-19.8 2.6-30.1 2.6c-96.9 0-175.5-78.8-175.5-176c0-65.8 36-123.1 89.3-153.3c6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-6.3-.5-12.6-.8-19-.8z"></path>
            </svg>
            <!-- SVG icon for light mode (e.g., a sun) -->
            <svg class="" id="lightIcon" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512">
                <!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
                <path d="M361.5 1.2c5 2.1 8.6 6.6 9.6 11.9L391 121l107.9 19.8c5.3 1 9.8 4.6 11.9 9.6s1.5 10.7-1.6 15.2L446.9 256l62.3 90.3c3.1 4.5 3.7 10.2 1.6 15.2s-6.6 8.6-11.9 9.6L391 391 371.1 498.9c-1 5.3-4.6 9.8-9.6 11.9s-10.7 1.5-15.2-1.6L256 446.9l-90.3 62.3c-4.5 3.1-10.2 3.7-15.2 1.6s-8.6-6.6-9.6-11.9L121 391 13.1 371.1c-5.3-1-9.8-4.6-11.9-9.6s-1.5-10.7 1.6-15.2L65.1 256 2.8 165.7c-3.1-4.5-3.7-10.2-1.6-15.2s6.6-8.6 11.9-9.6L121 121 140.9 13.1c1-5.3 4.6-9.8 9.6-11.9s10.7-1.5 15.2 1.6L256 65.1 346.3 2.8c4.5-3.1 10.2-3.7 15.2-1.6zM160 256a96 96 0 1 1 192 0 96 96 0 1 1 -192 0zm224 0a128 128 0 1 0 -256 0 128 128 0 1 0 256 0z"></path>
            </svg>
        </button>
    </div>
<div class="notification-container fixed top-5 p-2 max-h-[95vh] overflow-y-auto hidden" style="z-index: 999999;">
    <div class="bg-white border border-gray-300 shadow-sm p-5 rounded-md text-center dark:bg-gray-800 bg-white">
            <p class="text-2xl pb-5 text-black dark:text-white">Bad news</p>
            <p class="pb-3 text-black dark:text-white">
                We regret to inform you that our account on BuyMeACoffee has been suspended due to a violation of their terms of service. This was an unexpected development, and we are currently addressing the matter with utmost priority.
            <br>
        <br>
        However, our mission at Freedium remains unchanged, and your support is more crucial than ever. We are transitioning to Patreon, a platform that aligns with our values and offers us the freedom to share our work with you.
    <br>
<br>
Please join us on Patreon and continue to support our endeavors. Your contributions are invaluable to us, and we are committed to delivering the quality content you’ve come to expect from Freedium.
<br>
<br>
Thank you for your understanding and unwavering support.
<br>
<br>
Support Us on Patreon
<br>
<br>
Warm regards, The Freedium Team
</p>
<a href="https://patreon.com/Freedium" rel="noreferrer" target="_blank" title="Patreon">
    <button class="bg-red-400 mx-1 text-white hover:bg-red-500 font-semibold py-1 px-2 rounded mt-2">Patreon</button>
</a>
<button class="bg-gray-300 mx-1 hover:bg-gray-400 text-gray-800 font-semibold py-1 px-2 rounded mt-2 close-button">Close</button>
<a href="https://codeberg.org/Freedium-cfd/web" rel="noreferrer" target="_blank" title="Codeberg">
    <button class="bg-blue-800 hover:bg-blue-900 mx-1 text-white font-semibold py-1 px-2 rounded mt-2">
        Source
        code - Codeberg
    </button>
</a>
<a href="https://github.com/Freedium-cfd/web" rel="noreferrer" target="_blank" title="GitHub"></a>
<button class="bg-gray-700 hover:bg-gray-600 mx-1 text-white font-semibold py-1 px-2 rounded mt-2">
    Source code -
    GitHub
</button>

</div>
</div>
<nav id="header" class="fixed w-full z-9 top-0 dark:bg-gray-800 dark:text-white bg-white shadow" style="z-index: 999990;">
    
    <div id="progress" class="h-1 z-20 top-0" style="background: linear-gradient(to right, #4dc0b5 var(--scroll), transparent 0); --scroll: Infinity%;"></div>
    <div class="w-full md:max-w-4xl mx-auto flex flex-wrap items-center justify-between mt-0 py-3">
        <div class="pl-4">
            <a class="text-green-500 text-base no-underline hover:no-underline font-extrabold text-xl" href="https://www.freedium.cfd/" onclick="navigateToOrigin()">Freedium</a>
        </div>
        <div class="block lg:hidden pr-4">
            <button id="nav-toggle" class="flex items-center px-3 py-2 border rounded text-gray-500 dark:text-white border-gray-600 hover:text-gray-900 dark:hover:text-white hover:border-green-500 appearance-none focus:outline-none">
                <svg class="fill-current h-3 w-3" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <title>Menu</title>
                    <path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"></path>
                </svg>
            </button>
        </div>
        <div class="w-full flex-grow lg:flex lg:items-center lg:w-auto hidden lg:block mt-2 lg:mt-0 dark:bg-gray-800 bg-white" id="nav-content">
            <ul class="list-reset lg:flex justify-end flex-1 items-center">
                <li class="mr-3">
                    <a class="inline-block text-gray-600 dark:text-white no-underline hover:text-gray-900 dark:hover:text-white hover:text-underline py-2 px-4" href="https://codeberg.org/Freedium-cfd/web" target="_blank">Source code</a>
                </li>
                <li class="mr-3">
                    <a class="inline-block text-gray-600 dark:text-white no-underline hover:text-gray-900 dark:hover:text-white hover:text-underline py-2 px-4" href="https://romans-status-page.vercel.app/status/freedium" target="_blank">Status page</a>
                </li>
                <li class="mr-3">
                    <a class="inline-block text-gray-600 dark:text-white no-underline hover:text-gray-900 dark:hover:text-white hover:text-underline py-2 px-4" href="https://noref.io/#https://patreon.com/Freedium" target="_blank">Patreon - Support us</a>
                </li>
            </ul>
        </div>
    </div>
</nav>
<div class="container w-full md:max-w-3xl mx-auto pt-20 break-words text-gray-900 dark:text-gray-200 bg-white dark:bg-gray-800">
    <div class="w-full px-4 md:px-6 text-xl text-gray-800 dark:text-gray-100 leading-normal" style="font-family:Georgia,serif;">
        
        <div class="font-sans">
            <p class="text-base md:text-sm text-green-500 font-bold pb-3">
                <a href="https://medium.com/@code-geass/optimizing-postgresql-queries-from-300-seconds-to-2-seconds-for-billions-of-records-e6571a137a1a#bypass" class="text-sm md:text-sm text-green-500 font-bold no-underline hover:underline ">&lt; Go to the original</a>
            </p>
            
                <img alt="Preview image" style="max-height: 65vh;
                            width: auto;
                            margin: auto" loading="eager" role="presentation" src="./Optimizing PostgreSQL Queries_ From 300 Seconds to 2 Seconds for Billions of Records _ by Code Geass - Freedium_files/0_tmv2rcaI40loXDJb.png" class="lightense-target">
            
            <h1 class="font-bold font-sans break-normal text-gray-900 dark:text-gray-100 pt-6 pb-2 text-3xl md:text-4xl">Optimizing PostgreSQL Queries: From 300 Seconds to 2 Seconds for Billions of Records</h1>
            <h2 class="font-medium font-sans break-normal text-gray-600 dark:text-gray-200 pt-1 text-1xl md:text-1xl">I was working on a huge volumes where I had this entire experience of optimizing the PostgreSQL, to make it support huge data. This article…</h2>
        </div>
        <div class="bg-gray-100 dark:bg-gray-600 border border-gray-300 m-2 mt-5">
            <div class="flex items-center space-x-4 p-4">
                <div class="flex-shrink-0">
                    <a href="https://medium.com/@code-geass" target="_blank" title="Putting Software/ Tech in an Easy way" class="block relative">
                        <img src="./Optimizing PostgreSQL Queries_ From 300 Seconds to 2 Seconds for Billions of Records _ by Code Geass - Freedium_files/1_Di51UhUoHXPsogQLyjiSHw.jpg" alt="Code Geass" class="rounded-full h-11 w-11 no-lightense">
                        <div class="absolute bottom-0 right-0 h-3 w-3 border-2 border-white bg-green-500 rounded-full"></div>
                    </a>
                </div>
                <div class="flex-grow">
                    <a href="https://medium.com/@code-geass" target="_blank" title="Putting Software/ Tech in an Easy way" class="block font-semibold text-gray-900 dark:text-white">Code Geass</a>
                    <button class="text-sm text-white bg-green-500 px-3 py-1 rounded-lg mt-1 dark:bg-green-700">
                        <a href="https://medium.com/@code-geass" target="_blank" title="Putting Software/ Tech in an Easy way" class="block text-sm text-white">Follow</a>
                    </button>
                </div>
            </div>
            <div class="px-4 pb-2">
                <div class="flex flex-wrap items-center space-x-2 text-sm text-gray-500 dark:text-white">
                    
                    <span class="text-gray-500 dark:text-white">a11y-light</span>
                    <span class="md:inline">·</span>
                    <span class="text-gray-500 dark:text-white">August 26, 2024 (Updated: September 20, 2024)</span>
                    <span class="md:inline">·</span>
                    <span class="text-yellow-500 dark:text-yellow-400">Free: No</span>
                </div>
            </div>
        </div>
        <div class="main-content mt-8">
            <p class="leading-8 mt-7">I was working on a huge volumes where I had this entire experience of optimizing the PostgreSQL, to make it support huge data. This article is designed based on our ideas, implementations that we had during the course of this process of reduction of the execution time that finally came down to 2 seconds from a mammothing 150 seconds for the worst case scenerios.</p><p class="leading-8 mt-7"><em>Disclaimer: GPT-4 assisted me in writing this article, combining its insights with my personal experience.</em></p><h3 class="font-bold font-sans break-normal text-gray-900 dark:text-gray-100 text-1xl md:text-2xl pt-12">Table of Contents</h3><ol class="list-decimal pl-8 mt-2"><li class="mt-3"><a style="text-decoration: underline;" rel="noopener" title="" href="https://www.freedium.cfd/https://medium.com/@code-geass/optimizing-postgresql-queries-from-300-seconds-to-2-seconds-for-billions-of-records-e6571a137a1a#understanding-the-problem" target="_blank">Understanding the Problem</a></li><li class="mt-3"><a style="text-decoration: underline;" rel="noopener" title="" href="https://www.freedium.cfd/https://medium.com/@code-geass/optimizing-postgresql-queries-from-300-seconds-to-2-seconds-for-billions-of-records-e6571a137a1a#generating-billions-of-records" target="_blank">Generating Billions of Records</a></li><li class="mt-3"><a style="text-decoration: underline;" rel="noopener" title="" href="https://www.freedium.cfd/https://medium.com/@code-geass/optimizing-postgresql-queries-from-300-seconds-to-2-seconds-for-billions-of-records-e6571a137a1a#original-sql-query" target="_blank">Original SQL Query</a></li><li class="mt-3"><a style="text-decoration: underline;" rel="noopener" title="" href="https://www.freedium.cfd/https://medium.com/@code-geass/optimizing-postgresql-queries-from-300-seconds-to-2-seconds-for-billions-of-records-e6571a137a1a#first-optimization-indexes" target="_blank">First Optimization: Indexes</a></li><li class="mt-3"><a style="text-decoration: underline;" rel="noopener" title="" href="https://www.freedium.cfd/https://medium.com/@code-geass/optimizing-postgresql-queries-from-300-seconds-to-2-seconds-for-billions-of-records-e6571a137a1a#second-optimization-partitioning" target="_blank">Second Optimization: Partitioning</a></li><li class="mt-3"><a style="text-decoration: underline;" rel="noopener" title="" href="https://www.freedium.cfd/https://medium.com/@code-geass/optimizing-postgresql-queries-from-300-seconds-to-2-seconds-for-billions-of-records-e6571a137a1a#third-optimization-materialized-views" target="_blank">Third Optimization: Materialized Views</a></li><li class="mt-3"><a style="text-decoration: underline;" rel="noopener" title="" href="https://www.freedium.cfd/https://medium.com/@code-geass/optimizing-postgresql-queries-from-300-seconds-to-2-seconds-for-billions-of-records-e6571a137a1a#handling-edge-cases" target="_blank">Handling Edge Cases</a></li><li class="mt-3"><a style="text-decoration: underline;" rel="noopener" title="" href="https://www.freedium.cfd/https://medium.com/@code-geass/optimizing-postgresql-queries-from-300-seconds-to-2-seconds-for-billions-of-records-e6571a137a1a#final-results-and-best-practices" target="_blank">Final Results and Best Practices</a></li></ol><h3 class="font-bold font-sans break-normal text-gray-900 dark:text-gray-100 text-1xl md:text-2xl pt-12">Understanding the Problem</h3><p class="leading-8 mt-3">When working with massive datasets in PostgreSQL, poor table design, lack of indexing, and suboptimal query structures can lead to significant performance issues. In this scenario, we are optimizing a query that must process billions of records from a single table.</p><p class="leading-8 mt-7">Without optimization, this query was initially taking more than 150 seconds to execute, which is far from acceptable in a production environment.</p><h3 class="font-bold font-sans break-normal text-gray-900 dark:text-gray-100 text-1xl md:text-2xl pt-12">Generating Billions of Records</h3><p class="leading-8 mt-3">To simulate this scenario, let's first generate a table with billions of records using PostgreSQL's powerful data generation capabilities. The following table structure will be used:</p><pre class="mt-7 flex flex-col justify-center border dark:border-gray-700"><button class="hljs-copy p-1 bg-gray-300 dark:bg-zinc-800">Copy</button><code class="p-2 bg-gray-100 dark:bg-gray-900 overflow-x-auto language-sql hljs" data-highlighted="yes"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> transactions (
  transaction_id serial <span class="hljs-keyword">PRIMARY</span> KEY,
  user_id <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  transaction_date <span class="hljs-type">date</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  amount <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
);</code></pre><h3 class="font-bold font-sans break-normal text-gray-900 dark:text-gray-100 text-1xl md:text-2xl pt-12">Data Generation</h3><p class="leading-8 mt-3">The following stored procedure will generate 1 billion records:</p><pre class="mt-7 flex flex-col justify-center border dark:border-gray-700"><button class="hljs-copy p-1 bg-gray-300 dark:bg-zinc-800">Copy</button><code class="p-2 bg-gray-100 dark:bg-gray-900 overflow-x-auto language-sql hljs" data-highlighted="yes">DO $$
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">FOR</span> i <span class="hljs-keyword">IN</span> <span class="hljs-number">1.</span><span class="hljs-number">.1000000</span> LOOP
        <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> transactions (user_id, transaction_date, amount)
        <span class="hljs-keyword">SELECT</span>
            trunc(random() <span class="hljs-operator">*</span> <span class="hljs-number">10000</span> <span class="hljs-operator">+</span> <span class="hljs-number">1</span>),
            <span class="hljs-string">'2020-01-01'</span>::<span class="hljs-type">date</span> <span class="hljs-operator">+</span> trunc(random() <span class="hljs-operator">*</span> <span class="hljs-number">1000</span>),
            trunc(random() <span class="hljs-operator">*</span> <span class="hljs-number">1000</span> <span class="hljs-operator">+</span> <span class="hljs-number">1</span>)::<span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)
        <span class="hljs-keyword">FROM</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">1000</span>);
    <span class="hljs-keyword">END</span> LOOP;
<span class="hljs-keyword">END</span> $$;</code></pre><p class="leading-8 mt-7">This script inserts 1 billion transaction records, simulating a real-world, large-scale database.</p><h3 class="font-bold font-sans break-normal text-gray-900 dark:text-gray-100 text-1xl md:text-2xl pt-12">Original SQL Query</h3><p class="leading-8 mt-3">Our initial query attempts to calculate the total transaction amount for each user:</p><pre class="mt-7 flex flex-col justify-center border dark:border-gray-700"><button class="hljs-copy p-1 bg-gray-300 dark:bg-zinc-800">Copy</button><code class="p-2 bg-gray-100 dark:bg-gray-900 overflow-x-auto language-vbnet hljs" data-highlighted="yes"><span class="hljs-keyword">SELECT</span> user_id, SUM(amount) <span class="hljs-keyword">AS</span> total_amount
<span class="hljs-keyword">FROM</span> transactions
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> user_id;</code></pre><p class="leading-8 mt-7">Without any indexes, this query takes over 150 seconds to complete. The <em>Explain</em> output shows a full table scan, which is highly inefficient.</p><h3 class="font-bold font-sans break-normal text-gray-900 dark:text-gray-100 text-1xl md:text-2xl pt-12">First Optimization: Indexes</h3><h4 class="font-bold font-sans break-normal text-gray-900 dark:text-gray-100 text-l md:text-xl pt-8">Adding Indexes</h4><p class="leading-8 mt-3">To improve performance, we start by adding an index to the <em>user_id</em> column, which is used in the <em>Group By</em> clause:</p><pre class="mt-7 flex flex-col justify-center border dark:border-gray-700"><button class="hljs-copy p-1 bg-gray-300 dark:bg-zinc-800">Copy</button><code class="p-2 bg-gray-100 dark:bg-gray-900 overflow-x-auto language-cpp hljs" data-highlighted="yes"><span class="hljs-function">CREATE INDEX idx_user_id ON <span class="hljs-title">transactions</span> <span class="hljs-params">(user_id)</span></span>;</code></pre><h4 class="font-bold font-sans break-normal text-gray-900 dark:text-gray-100 text-l md:text-xl pt-8">Revised Query Execution</h4><p class="leading-8 mt-3">After adding the index, the query's execution time dropped to around 80 seconds. While this is an improvement, it's still not fast enough. The <em>Explain</em> output shows that the index is being used, but the process remains I/O-bound due to the sheer volume of data.</p><h3 class="font-bold font-sans break-normal text-gray-900 dark:text-gray-100 text-1xl md:text-2xl pt-12">Second Optimization: Partitioning</h3><h4 class="font-bold font-sans break-normal text-gray-900 dark:text-gray-100 text-l md:text-xl pt-8">Implementing Table Partitioning</h4><p class="leading-8 mt-3">To further optimize the query, we introduce partitioning based on <em>transcation_date</em>. Partitioning allows PostgreSQL to divide the table into smaller, more manageable pieces, thereby reducing the data each query needs to scan.</p><pre class="mt-7 flex flex-col justify-center border dark:border-gray-700"><button class="hljs-copy p-1 bg-gray-300 dark:bg-zinc-800">Copy</button><code class="p-2 bg-gray-100 dark:bg-gray-900 overflow-x-auto language-sql hljs" data-highlighted="yes"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> transactions_partitioned (
  transaction_id serial <span class="hljs-keyword">PRIMARY</span> KEY,
  user_id <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  transaction_date <span class="hljs-type">date</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  amount <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
) <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span> (transaction_date)
;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> transactions_2020 <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> transactions_partitioned
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-string">'2020-01-01'</span>) <span class="hljs-keyword">TO</span> (<span class="hljs-string">'2021-01-01'</span>);

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> transactions_2021 <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">OF</span> transactions_partitioned
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">VALUES</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-string">'2021-01-01'</span>) <span class="hljs-keyword">TO</span> (<span class="hljs-string">'2022-01-01'</span>);</code></pre><h4 class="font-bold font-sans break-normal text-gray-900 dark:text-gray-100 text-l md:text-xl pt-8">Query Execution on Partitioned Tables</h4><p class="leading-8 mt-3">After partitioning, the query execution time decreased significantly to around 20 seconds. The <em>Explain</em> plan now shows that only the relevant partitions are being scanned, which reduces the amount of data processed.</p><h3 class="font-bold font-sans break-normal text-gray-900 dark:text-gray-100 text-1xl md:text-2xl pt-12">Third Optimization: Materialized Views</h3><h4 class="font-bold font-sans break-normal text-gray-900 dark:text-gray-100 text-l md:text-xl pt-8">Creating a Materialized View</h4><p class="leading-8 mt-3">To push the optimization further, we introduce a materialized view to pre-calculate the sums for each user, reducing the need to repeatedly aggregate the entire dataset</p><pre class="mt-7 flex flex-col justify-center border dark:border-gray-700"><button class="hljs-copy p-1 bg-gray-300 dark:bg-zinc-800">Copy</button><code class="p-2 bg-gray-100 dark:bg-gray-900 overflow-x-auto language-sql hljs" data-highlighted="yes"><span class="hljs-keyword">CREATE</span> MATERIALIZED <span class="hljs-keyword">VIEW</span> user_transaction_sums <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> user_id, <span class="hljs-built_in">SUM</span>(amount) <span class="hljs-keyword">AS</span> total_amount
<span class="hljs-keyword">FROM</span> transactions_partitioned
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> user_id;</code></pre><h4 class="font-bold font-sans break-normal text-gray-900 dark:text-gray-100 text-l md:text-xl pt-8">Final Query Using Materialized View</h4><p class="leading-8 mt-3">The final query is now a simple <em>SELECT</em> from the materialized view:</p><pre class="mt-7 flex flex-col justify-center border dark:border-gray-700"><button class="hljs-copy p-1 bg-gray-300 dark:bg-zinc-800">Copy</button><code class="p-2 bg-gray-100 dark:bg-gray-900 overflow-x-auto language-sql hljs" data-highlighted="yes"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> user_transaction_sums;</code></pre><p class="leading-8 mt-7">This query executes in less than 2 seconds, achieving the performance target.</p><h3 class="font-bold font-sans break-normal text-gray-900 dark:text-gray-100 text-1xl md:text-2xl pt-12">Handling Edge Cases</h3><p class="leading-8 mt-3">While the above optimizations significantly improved performance, there are several edge cases that need to be considered to ensure consistent results and avoid unexpected performance degradation.</p><p class="leading-8 mt-7"><strong>1. Handling Skewed Data Distribution</strong></p><p class="leading-8 mt-7">In cases where the data is heavily skewed, with certain <em>user_ids</em> having a disproportionate number of transactions, partitioning and indexing strategies might not be sufficient. To address this, consider:</p><ul class="list-disc pl-8 mt-2"><li class="mt-3"><strong>Hash Partitioning:</strong> Use hash partitioning on <em>user_id</em> to evenly distribute data across partitions.</li><li class="mt-3"><strong>Partial Indexes:</strong> Create partial indexes on frequently accessed users, e.g., users with the most transactions.</li></ul><pre class="mt-7 flex flex-col justify-center border dark:border-gray-700"><button class="hljs-copy p-1 bg-gray-300 dark:bg-zinc-800">Copy</button><code class="p-2 bg-gray-100 dark:bg-gray-900 overflow-x-auto language-sql hljs" data-highlighted="yes"><span class="hljs-keyword">CREATE</span> INDEX idx_high_activity_users <span class="hljs-keyword">ON</span> transactions (user_id) 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> user_id <span class="hljs-keyword">FROM</span> transactions <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> user_id <span class="hljs-keyword">HAVING</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-operator">&gt;</span> <span class="hljs-number">1000000</span>);</code></pre><p class="leading-8 mt-7"><strong>2. High Cardinality Columns</strong></p><p class="leading-8 mt-7">If the dataset includes high-cardinality columns (e.g., <em>transaction_id</em>), indexing these may lead to large index sizes that negatively impact performance. In such cases:</p><ul class="list-disc pl-8 mt-2"><li class="mt-3"><strong>Composite Indexes:</strong> Use composite indexes combining high-cardinality columns with lower-cardinality columns to improve selectivity.</li></ul><pre class="mt-7 flex flex-col justify-center border dark:border-gray-700"><button class="hljs-copy p-1 bg-gray-300 dark:bg-zinc-800">Copy</button><code class="p-2 bg-gray-100 dark:bg-gray-900 overflow-x-auto language-cpp hljs" data-highlighted="yes"><span class="hljs-function">CREATE INDEX idx_composite_user_date ON <span class="hljs-title">transactions</span> <span class="hljs-params">(user_id, transaction_date)</span></span>;</code></pre><ul class="list-disc pl-8 mt-2"><li class="mt-3"><strong>Clustered Indexing:</strong> Consider clustering the table by <em>user_id</em>, allowing sequential reads, which are faster for grouped queries.</li></ul><p class="leading-8 mt-7"><strong>3. Frequent Data Updates</strong></p><p class="leading-8 mt-7">For databases with frequent updates or inserts, maintaining materialized views and indexes can become costly. In such scenarios:</p><ul class="list-disc pl-8 mt-2"><li class="mt-3"><strong>Incremental Updates:</strong> Use PostgreSQL's<em> Refresh Materialized view concurrently</em> to update materialized views without locking the table.</li></ul><pre class="mt-7 flex flex-col justify-center border dark:border-gray-700"><button class="hljs-copy p-1 bg-gray-300 dark:bg-zinc-800">Copy</button><code class="p-2 bg-gray-100 dark:bg-gray-900 overflow-x-auto language-sql hljs" data-highlighted="yes">REFRESH MATERIALIZED <span class="hljs-keyword">VIEW</span> CONCURRENTLY user_transaction_sums;</code></pre><ul class="list-disc pl-8 mt-2"><li class="mt-3"><strong>Avoid Over-Indexing:</strong> Balance the number of indexes with the write workload. Too many indexes can slow down inserts and updates.</li></ul><p class="leading-8 mt-7"><strong>4. Join Performance Issues</strong></p><p class="leading-8 mt-7">When dealing with joins between large tables, PostgreSQL's query planner may not always choose the most efficient plan, especially with complex queries. Solutions include:</p><ul class="list-disc pl-8 mt-2"><li class="mt-3"><strong>Join Hints:</strong> While PostgreSQL doesn't natively support optimizer hints like some other databases, restructuring queries to encourage nested loop joins or hash joins based on your dataset can improve performance.</li><li class="mt-3"><strong>Query Rewriting:</strong> Rewrite queries to simplify joins, possibly using Common Table Expressions (CTEs) to break down complex queries into more manageable parts.</li></ul><pre class="mt-7 flex flex-col justify-center border dark:border-gray-700"><button class="hljs-copy p-1 bg-gray-300 dark:bg-zinc-800">Copy</button><code class="p-2 bg-gray-100 dark:bg-gray-900 overflow-x-auto language-vbnet hljs" data-highlighted="yes"><span class="hljs-keyword">WITH</span> user_sums <span class="hljs-keyword">AS</span> (
  <span class="hljs-keyword">SELECT</span> user_id, SUM(amount) <span class="hljs-keyword">AS</span> total_amount
  <span class="hljs-keyword">FROM</span> transactions
  <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> user_id
)
<span class="hljs-keyword">SELECT</span> u.user_id, u.name, us.total_amount
<span class="hljs-keyword">FROM</span> users u
<span class="hljs-keyword">JOIN</span> user_sums us <span class="hljs-keyword">ON</span> u.user_id = us.user_id;</code></pre><p class="leading-8 mt-7"><strong>5. Query Timeouts</strong></p><p class="leading-8 mt-7">For particularly long-running queries, it's essential to handle potential timeouts gracefully:</p><ul class="list-disc pl-8 mt-2"><li class="mt-3"><strong>Query Cancellation:</strong> Implement logic to catch and handle query cancellations, especially in client applications.</li></ul><pre class="mt-7 flex flex-col justify-center border dark:border-gray-700"><button class="hljs-copy p-1 bg-gray-300 dark:bg-zinc-800">Copy</button><code class="p-2 bg-gray-100 dark:bg-gray-900 overflow-x-auto language-sql hljs" data-highlighted="yes"><span class="hljs-keyword">BEGIN</span>;
<span class="hljs-keyword">SET</span> statement_timeout <span class="hljs-operator">=</span> <span class="hljs-string">'30s'</span>;
<span class="hljs-keyword">SELECT</span> user_id, <span class="hljs-built_in">SUM</span>(amount) <span class="hljs-keyword">FROM</span> transactions <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> user_id;
<span class="hljs-keyword">COMMIT</span>;</code></pre><ul class="list-disc pl-8 mt-2"><li class="mt-3"><strong>Progressive Aggregation:</strong> Break down large aggregations into smaller batches or stages, potentially using temporary tables to store intermediate results.</li></ul><h3 class="font-bold font-sans break-normal text-gray-900 dark:text-gray-100 text-1xl md:text-2xl pt-12">Final Results and Best Practices</h3><p class="leading-8 mt-3">The combination of indexing, partitioning, materialized views, and handling edge cases transformed a 150-second query into a sub-2-second query. Here are the key takeaways:</p><ol class="list-decimal pl-8 mt-2"><li class="mt-3"><strong>Indexes</strong>: Start with proper indexing on columns used in <em>Where</em>, <em>Join</em> , and <em>Group By</em> clauses.</li><li class="mt-3"><strong>Partitioning</strong>: Use table partitioning to break down large tables, reducing the data scanned by queries.</li><li class="mt-3"><strong>Materialized Views</strong>: Pre-compute complex aggregates to save query execution time.</li><li class="mt-3"><strong>Edge Case Handling</strong>: Be aware of and address edge cases like skewed data, high cardinality, frequent updates, and complex joins.</li></ol><h3 class="font-bold font-sans break-normal text-gray-900 dark:text-gray-100 text-1xl md:text-2xl pt-12">Next Steps</h3><p class="leading-8 mt-3">For even larger datasets, consider:</p><ul class="list-disc pl-8 mt-2"><li class="mt-3">Using <em>pg_partman</em> for automated partition management.</li><li class="mt-3">Exploring parallel query execution and tuning PostgreSQL's settings for optimal performance.</li><li class="mt-3">Leveraging caching layers like Redis for frequently accessed data.</li></ul><p class="leading-8 mt-7">By applying these strategies, PostgreSQL can handle even the most demanding datasets efficiently.</p>
        </div>
        <div class="flex flex-wrap gap-2 mt-5">
            <a title="Postgresql" target="_blank" href="https://medium.com/tag/postgresql"><span class="text-green-500 bg-green-100 px-2 py-1 rounded-full text-xs dark:bg-green-800 dark:text-gray-100">#postgresql</span></a><a title="Database" target="_blank" href="https://medium.com/tag/database"><span class="text-green-500 bg-green-100 px-2 py-1 rounded-full text-xs dark:bg-green-800 dark:text-gray-100">#database</span></a><a title="Software Development" target="_blank" href="https://medium.com/tag/software-development"><span class="text-green-500 bg-green-100 px-2 py-1 rounded-full text-xs dark:bg-green-800 dark:text-gray-100">#software-development</span></a><a title="Software Engineering" target="_blank" href="https://medium.com/tag/software-engineering"><span class="text-green-500 bg-green-100 px-2 py-1 rounded-full text-xs dark:bg-green-800 dark:text-gray-100">#software-engineering</span></a><a title="Distributed Systems" target="_blank" href="https://medium.com/tag/distributed-systems"><span class="text-green-500 bg-green-100 px-2 py-1 rounded-full text-xs dark:bg-green-800 dark:text-gray-100">#distributed-systems</span></a>
        </div>
        <div class="container w-full md:max-w-3xl mx-auto pt-12"></div>
    </div>
    <style>
.main-content {
 letter-spacing: -0.06px;
 font-family: source-serif-pro, Georgia, Cambria, "Times New Roman", Times, serif;
}
pre {
    font-size: 75%;
    background-color: #e3e2e2;
}
p code, ul code, li code {
    font-size: 75%;
}
    </style>
    <script>
document.addEventListener('DOMContentLoaded', (event) => {
  hljs.highlightAll();

  document.querySelectorAll('pre code').forEach((el) => {
        code = el.textContent;
        el = el.parentElement;
        el.innerHTML = '<button class="hljs-copy p-1 bg-gray-300 dark:bg-zinc-800">Copy</button>' + el.innerHTML; // append copy button
        el.getElementsByClassName('hljs-copy')[0].contentCopy = code;
         el.getElementsByClassName('hljs-copy')[0].addEventListener("click", function () {
             this.innerText = 'Copying..';
             if (!navigator.userAgent.toLowerCase().includes('safari')) {
                 navigator.clipboard.writeText(this.contentCopy);
             } else {
                 prompt("Clipboard (Select: ⌘+a > Copy:⌘+c)", this.contentCopy);
             }
             this.innerText = 'Copied!';
             button = this;
             setTimeout(function () {
                 button.innerText = 'Copy';
             }, 1500)
         });
});
  });
    </script>
    <style>
     .hljs-copy {
         float: right;
         cursor: pointer;
     }
    </style>
<div id="problemModal" class="modal hidden fixed inset-0 w-full h-full flex items-center justify-center overflow-y-auto bg-black bg-opacity-50" style="z-index: 999999">
    <div class="modal-container w-11/12 md:max-w-xl mx-auto rounded shadow-lg max-h-screen">
        <div class="modal-content bg-white dark:bg-gray-800 text-black dark:text-white my-8 py-4 text-left px-6">
            <h1 class="text-3xl font-bold">Reporting a Problem</h1>
            <div class="mt-3">
                <p>
                    Sometimes we have problems displaying some Medium posts.
                <br>
            <br>
        </p>
        <p>If you have a problem that some images aren't loading - try using VPN. Probably you have problem with access to Medium CDN (or fucking Cloudflare's bot detection algorithms are blocking you).</p>
    </div>
    <form action="https://www.freedium.cfd/https://medium.com/@code-geass/optimizing-postgresql-queries-from-300-seconds-to-2-seconds-for-billions-of-records-e6571a137a1a#" method="POST" class="mt-4" id="problem-form">
        <div class="mb-4">
            <label for="problem-description" class="block text-gray-700 dark:text-white font-bold mb-2">Problem Description</label>
            <textarea id="problem-description" name="problem-description" placeholder="Describe your problem here..." class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" rows="4" required=""></textarea>
        </div>
        <div>
            <button type="submit" class="m-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Submit</button>
            <button type="button" class="m-2 modal-close bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Cancel</button>
        </div>
    </form>
</div>
</div>
</div>
<script>
    tailwind.config = {
        darkMode: 'class',
    }

        function changeTheme(themeName) {
            // Source: https://stackoverflow.com/questions/59257368/how-to-dynamically-change-the-theme-using-highlight-js
            console.log(`Applying theme: ${themeName}`);
            const existingLink = document.querySelector('link[href*="highlight.js"]');
            if (existingLink) {
                existingLink.remove();
            }
            const link = document.createElement("link");
            link.rel = "stylesheet";
            link.href = `https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/${themeName}.min.css`;
            document.head.appendChild(link);
            document.querySelector("span").textContent = themeName;
        }

        function navigateToOrigin() {
            window.location.href = window.location.origin;
        }

    function updateThemeIcons() {
        const isDarkMode = localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
        document.getElementById('darkIcon').classList.toggle('hidden', !isDarkMode);
        document.getElementById('lightIcon').classList.toggle('hidden', isDarkMode);
}

        updateThemeIcons();

        document.getElementById('darkModeToggle').addEventListener('click', function () {
            const isDarkMode = localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (isDarkMode) {
                document.documentElement.classList.remove('dark');
        document.documentElement.style.cssText = "--lightense-backdrop: white;";
        localStorage.setItem("theme", "light");
        changeTheme("a11y-light");
    } else {
        document.documentElement.classList.add('dark');
        document.documentElement.style.cssText = "--lightense-backdrop: black;";
        localStorage.setItem("theme", "dark");
        changeTheme("androidstudio");
    }
        updateThemeIcons();
    })

        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            //document.getElementById('darkIcon').classList.remove('hidden');
            //document.getElementById('lightIcon').classList.add('hidden')
            changeTheme("androidstudio");
        } else {
            document.documentElement.classList.remove('dark')
            //document.getElementById('lightIcon').classList.remove('hidden');
            //document.getElementById('darkIcon').classList.add('hidden');
            changeTheme("a11y-light");
        }
</script>
<script>
                const openModalButton = document.getElementById('openProblemModal');
                const closeModalButton = document.querySelector('.modal-close');
                const modal = document.getElementById('problemModal');
                const problemDescriptionInput = document.getElementById('problem-description');
                const submitButton = document.querySelector('form button');
                const body = document.querySelector('body');

                openModalButton.addEventListener('click', () => {
                    body.classList.add('!overflow-hidden'); // Prevent scrolling on the body
            modal.classList.remove('hidden');
        });

        closeModalButton.addEventListener('click', () => {
            body.classList.remove('!overflow-hidden'); // Re-enable scrolling on the body
            modal.classList.add('hidden');
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
                body.classList.remove('!overflow-hidden');
            }
        });

        function navigateNoCache() {
                window.location.href = `/render-no-cache${window.location.pathname}`;
        }

        const submitForm = async (event) => {
            event.preventDefault();

            console.log('Form submiting is started!');
            submitButton.disabled = true;

            // Get the problem description from the input field
            const problemDescription = problemDescriptionInput.value;
            const currentPage = window.location.href;

            try {
                // Send a POST request to the "report-problem" API endpoint
                const response = await fetch('/report-problem', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ description: problemDescription, page: currentPage }),
                });

                if (response.ok) {
                    // Report submitted successfully, you can add a success message or further actions here
                    console.log('Problem report submitted successfully.');
                    modal.classList.add('hidden'); // Close the modal
                } else {
                    // Handle errors, such as non-200 responses
                    console.error('Failed to submit problem report.');
                    submitButton.disabled = false;
                }
            } catch (error) {
                // Handle network errors or other exceptions
                console.error('An error occurred:', error);
                submitButton.disabled = false;
            }
        };

        document.getElementById('problem-form').onsubmit = submitForm;
</script>
<script>
const h = document.documentElement, b = document.body;
const st = 'scrollTop';
const sh = 'scrollHeight';
const progress = document.getElementById('progress');
const header = document.getElementById('header');
const navcontent = document.getElementById('nav-content');

document.addEventListener('scroll', function () {
  /* Refresh scroll % width */
  const scroll = (h[st] || b[st]) / ((h[sh] || b[sh]) - h.clientHeight) * 100;
  progress.style.setProperty('--scroll', scroll + '%');

  /* Apply classes for slide in bar */
  const shouldAddClass = window.scrollY > 10;
});

		document.getElementById('nav-toggle').onclick = function() {
			document.getElementById("nav-content").classList.toggle("hidden");
		}

  window.addEventListener('load', function () {
       Lightense('img:not(.no-lightense)');
  }, false);
</script>
<script>
            var lazyLoadInstance = new LazyLoad({
                    callback_loaded: function(element) {
                    console.log(element);
                    console.log(element.tagName);
                    switch (element.tagName) {
                        case "IMG":
                            console.log(`${element} is image, wrapping into lightense`);
                            Lightense(element);
                            break;
                        case "IFRAME":
                            const resizeIframe = () => {
                                console.log(`${element} is iframe, wrapping script`);
                                let iframeHeight = element.contentWindow.document.body.scrollHeight;
                                if (iframeHeight == 150) {
                                    iframeHeight = 500;
                                }
                                element.style.height = iframeHeight + 'px';
                            };
                            window.addEventListener('resize', resizeIframe);
                            setInterval(resizeIframe, 4500);
                            resizeIframe();
                            break;
                    }
                },
                callback_error: (element) => {
                    console.log(element);
                    if (element.tagName === "IMG" && element.hasAttribute("data-src")) {
                        const srcAttribute = element.attributes["data-src"].value;
                        if (srcAttribute.startsWith("https://miro.medium.com/v2/")) {
                            element.setAttribute("src", srcAttribute.replace("https://miro.medium.com/v2/", "https://freedium.cfd/@miro/v2/"));
                        }
                    }
                }
            });
</script>
<script>
    function navigateToOrigin() {
      window.location.href = window.location.origin;
    }
</script>
<script>
      document.addEventListener('DOMContentLoaded', () => {
        const notificationContainer = document.querySelector('.notification-container');
        const closeButton = document.querySelector('.close-button');
        const notificationFlagString = "showNotification-buymeacoffe-ban-block"
        const body = document.querySelector('body');

        function showNotification() {
          if (!localStorage.getItem(notificationFlagString)) {
                  notificationContainer.style.display = 'block';
              body.classList.add('!overflow-hidden');
          }
        }

        function hideNotification() {
          localStorage.setItem(notificationFlagString, 'false');
          notificationContainer.style.display = 'none';
            body.classList.remove('!overflow-hidden');
        }

        // Close button functionality
        closeButton.addEventListener('click', () => {
          hideNotification();
        });

        showNotification();
      });
</script>


</div><div class="lightense-backdrop"></div></body></html>